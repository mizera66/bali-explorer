'use client';

import { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { ArrowLeft, Star, Heart, Phone, MessageCircle, MapPin, ExternalLink, Instagram } from 'lucide-react';
import { Entity, Comment, defaultComments } from '@/data/db';
import LazyImage from '@/components/LazyImage';
import Toast from '@/components/Toast';

export default function EntityDetailPage() {
  const params = useParams();
  const router = useRouter();
  const entityId = params.id as string;

  const [entity, setEntity] = useState<Entity | null>(null);
  const [loading, setLoading] = useState(true);
  const [isFavorite, setIsFavorite] = useState(false);
  const [userRating, setUserRating] = useState(0);
  const [hoverRating, setHoverRating] = useState(0);
  const [showCommentForm, setShowCommentForm] = useState(false);
  const [commentText, setCommentText] = useState('');
  const [authorName, setAuthorName] = useState('');
  const [comments, setComments] = useState<Comment[]>([]);
  const [showToast, setShowToast] = useState(false);
  const [toastMessage, setToastMessage] = useState('');

  useEffect(() => {
    loadEntity();
    loadFavoriteStatus();
    loadUserRating();
    loadComments();
  }, [entityId]);

  const loadEntity = async () => {
    try {
      const response = await fetch(`/api/entities`);
      const data = await response.json();
      const found = data.entities.find((e: Entity) => e.id === entityId);
      setEntity(found || null);
    } catch (error) {
      console.error('Failed to load entity:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadFavoriteStatus = () => {
    const favorites = JSON.parse(localStorage.getItem('bali-explorer-favorites') || '[]');
    setIsFavorite(favorites.includes(entityId));
  };

  const loadUserRating = () => {
    const ratings = JSON.parse(localStorage.getItem('bali-explorer-ratings') || '{}');
    setUserRating(ratings[entityId] || 0);
  };

  const loadComments = () => {
    // Load comments from localStorage
    const stored = JSON.parse(localStorage.getItem('bali-explorer-comments') || '{}');
    const entityComments = stored[entityId] || [];
    
    // Load default comment for this entity
    const defaultComment = defaultComments.find(c => c.entity_id === entityId);
    
    // Combine: user comments + default comment, sorted by date (newest first)
    const allComments = defaultComment 
      ? [...entityComments, defaultComment]
      : entityComments;
    
    allComments.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
    setComments(allComments);
  };

  const toggleFavorite = () => {
    const favorites = JSON.parse(localStorage.getItem('bali-explorer-favorites') || '[]');
    
    if (favorites.includes(entityId)) {
      const updated = favorites.filter((id: string) => id !== entityId);
      localStorage.setItem('bali-explorer-favorites', JSON.stringify(updated));
      setIsFavorite(false);
    } else {
      favorites.push(entityId);
      localStorage.setItem('bali-explorer-favorites', JSON.stringify(favorites));
      setIsFavorite(true);
    }
  };

  const submitRating = (rating: number) => {
    setUserRating(rating);
    setShowCommentForm(true); // Show comment form after rating
  };

  const submitComment = () => {
    if (!userRating) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
      return;
    }

    // Check if user already commented
    const myComments = JSON.parse(localStorage.getItem('bali-my-comments') || '[]');
    const alreadyCommented = comments.some(c => myComments.includes(c.id));
    
    if (alreadyCommented) {
      setToastMessage('–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ –º–µ—Å—Ç–æ');
      setShowToast(true);
      return;
    }

    // Validate comment length
    if (commentText.trim() && commentText.trim().length < 10) {
      alert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 10 —Å–∏–º–≤–æ–ª–æ–≤');
      return;
    }

    if (commentText.trim().length > 500) {
      alert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 500 —Å–∏–º–≤–æ–ª–æ–≤');
      return;
    }

    // Create new comment
    const newComment: Comment = {
      id: `comment-${Date.now()}`,
      entity_id: entityId,
      rating: userRating,
      text: commentText.trim() || '',
      author: authorName.trim() || '–ê–Ω–æ–Ω–∏–º',
      created_at: new Date().toISOString(),
    };

    // Save to localStorage
    const stored = JSON.parse(localStorage.getItem('bali-explorer-comments') || '{}');
    if (!stored[entityId]) {
      stored[entityId] = [];
    }
    stored[entityId].push(newComment);
    localStorage.setItem('bali-explorer-comments', JSON.stringify(stored));

    // Save my comment ID
    myComments.push(newComment.id);
    localStorage.setItem('bali-my-comments', JSON.stringify(myComments));

    // Save rating
    const ratings = JSON.parse(localStorage.getItem('bali-explorer-ratings') || '{}');
    ratings[entityId] = userRating;
    localStorage.setItem('bali-explorer-ratings', JSON.stringify(ratings));

    // Reset form
    setCommentText('');
    setAuthorName('');
    setShowCommentForm(false);

    // Reload comments
    loadComments();

    // Show success toast
    setToastMessage('‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à –æ—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω');
    setShowToast(true);
  };

  const skipComment = () => {
    // Just save rating without comment
    const ratings = JSON.parse(localStorage.getItem('bali-explorer-ratings') || '{}');
    ratings[entityId] = userRating;
    localStorage.setItem('bali-explorer-ratings', JSON.stringify(ratings));

    setShowCommentForm(false);
    
    setToastMessage(`–°–ø–∞—Å–∏–±–æ! –í—ã –ø–æ—Å—Ç–∞–≤–∏–ª–∏ ${userRating} ${userRating === 1 ? '–∑–≤–µ–∑–¥—É' : userRating < 5 ? '–∑–≤–µ–∑–¥—ã' : '–∑–≤–µ–∑–¥'}`);
    setShowToast(true);
  };

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffDays === 0) return '–°–µ–≥–æ–¥–Ω—è';
    if (diffDays === 1) return '–í—á–µ—Ä–∞';
    if (diffDays < 7) return `${diffDays} –¥–Ω. –Ω–∞–∑–∞–¥`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)} –Ω–µ–¥. –Ω–∞–∑–∞–¥`;
    return `${Math.floor(diffDays / 30)} –º–µ—Å. –Ω–∞–∑–∞–¥`;
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
          <p className="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
      </div>
    );
  }

  if (!entity) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <h2 className="text-2xl font-bold text-gray-900 mb-2">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</h2>
          <button
            onClick={() => router.back()}
            className="text-primary hover:underline"
          >
            –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 pb-20">
      <Toast message={toastMessage} show={showToast} onClose={() => setShowToast(false)} />

      {/* Header */}
      <div className="bg-white border-b border-gray-200 sticky top-0 z-40">
        <div className="max-w-4xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <button
              onClick={() => router.back()}
              className="p-2 hover:bg-gray-100 rounded-xl transition-colors"
            >
              <ArrowLeft size={24} />
            </button>
            
            <button
              onClick={toggleFavorite}
              className={`p-3 rounded-full transition-all ${
                isFavorite ? 'bg-red-50' : 'bg-gray-100'
              }`}
            >
              <Heart
                size={24}
                className={isFavorite ? 'fill-red-500 text-red-500' : 'text-gray-600'}
              />
            </button>
          </div>
        </div>
      </div>

      {/* Content */}
      <div className="max-w-4xl mx-auto px-4 py-6">
        {/* Image */}
        {entity.image_url && (
          <div className="mb-6 rounded-2xl overflow-hidden">
            <LazyImage
              src={entity.image_url}
              alt={entity.title}
              aspectRatio="16/9"
            />
          </div>
        )}

        {/* Title & Area */}
        <div className="mb-6">
          <h1 className="text-3xl font-display font-bold text-gray-900 mb-2">
            {entity.title}
          </h1>
          <div className="flex items-center gap-3 text-gray-600">
            <span>{entity.area}</span>
            <span>‚Ä¢</span>
            <span className="text-primary font-bold">
              {'$'.repeat(entity.price_level)}
            </span>
          </div>
        </div>

        {/* Rating Section */}
        <div className="bg-white rounded-2xl p-6 shadow-card mb-6">
          <h2 className="text-xl font-bold text-gray-900 mb-4">–†–µ–π—Ç–∏–Ω–≥ –∏ –æ—Ç–∑—ã–≤—ã</h2>
          
          {/* Current Rating */}
          <div className="flex items-center gap-3 mb-4">
            <div className="flex items-center gap-1">
              {[1, 2, 3, 4, 5].map((star) => (
                <Star
                  key={star}
                  size={20}
                  className={
                    star <= Math.floor(entity.rating)
                      ? 'fill-yellow-400 text-yellow-400'
                      : 'text-gray-300'
                  }
                />
              ))}
            </div>
            <span className="text-xl font-bold text-gray-900">
              {entity.rating.toFixed(1)}
            </span>
            <span className="text-gray-500">
              ({comments.length} {comments.length === 1 ? '–æ—Ç–∑—ã–≤' : comments.length < 5 ? '–æ—Ç–∑—ã–≤–∞' : '–æ—Ç–∑—ã–≤–æ–≤'})
            </span>
          </div>

          {/* User Rating */}
          {!showCommentForm && (
            <div className="pt-4 border-t border-gray-200">
              <p className="text-sm font-medium text-gray-700 mb-3">
                {userRating > 0 ? '–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞:' : '–û—Ü–µ–Ω–∏—Ç–µ —ç—Ç–æ –º–µ—Å—Ç–æ:'}
              </p>
              <div className="flex items-center gap-2">
                {[1, 2, 3, 4, 5].map((star) => (
                  <button
                    key={star}
                    onClick={() => submitRating(star)}
                    onMouseEnter={() => setHoverRating(star)}
                    onMouseLeave={() => setHoverRating(0)}
                    className="transition-transform hover:scale-110"
                  >
                    <Star
                      size={32}
                      className={
                        star <= (hoverRating || userRating)
                          ? 'fill-yellow-400 text-yellow-400'
                          : 'text-gray-300'
                      }
                    />
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Comment Form (appears after rating) */}
          {showCommentForm && (
            <div className="pt-4 border-t border-gray-200">
              <p className="text-sm font-medium text-gray-700 mb-3">
                –í—ã –ø–æ—Å—Ç–∞–≤–∏–ª–∏ {userRating} {userRating === 1 ? '–∑–≤–µ–∑–¥—É' : userRating < 5 ? '–∑–≤–µ–∑–¥—ã' : '–∑–≤–µ–∑–¥'}. –•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤?
              </p>
              
              <input
                type="text"
                value={authorName}
                onChange={(e) => setAuthorName(e.target.value)}
                placeholder="–í–∞—à–µ –∏–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
                className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary mb-3"
                maxLength={50}
              />

              <textarea
                value={commentText}
                onChange={(e) => setCommentText(e.target.value)}
                placeholder="–í–∞—à –æ—Ç–∑—ã–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, 10-500 —Å–∏–º–≤–æ–ª–æ–≤)"
                className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary mb-4 resize-none"
                rows={4}
                maxLength={500}
              />

              <div className="flex gap-3">
                <button
                  onClick={submitComment}
                  className="flex-1 bg-primary text-white py-3 rounded-xl font-medium hover:bg-primary/90 transition-colors"
                >
                  –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                </button>
                <button
                  onClick={skipComment}
                  className="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors"
                >
                  –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
                </button>
              </div>
            </div>
          )}
        </div>

        {/* Comments List */}
        {comments.length > 0 && (
          <div className="bg-white rounded-2xl p-6 shadow-card mb-6">
            <h2 className="text-xl font-bold text-gray-900 mb-4">
              üí¨ –û—Ç–∑—ã–≤—ã ({comments.length})
            </h2>
            
            <div className="space-y-4">
              {comments.map((comment) => (
                <div key={comment.id} className="border-b border-gray-200 last:border-0 pb-4 last:pb-0">
                  {/* Rating stars */}
                  <div className="flex items-center gap-1 mb-2">
                    {[1, 2, 3, 4, 5].map((star) => (
                      <Star
                        key={star}
                        size={16}
                        className={
                          star <= comment.rating
                            ? 'fill-yellow-400 text-yellow-400'
                            : 'text-gray-300'
                        }
                      />
                    ))}
                  </div>
                  
                  {/* Comment text */}
                  {comment.text && (
                    <p className="text-gray-700 mb-2 leading-relaxed">
                      {comment.text}
                    </p>
                  )}
                  
                  {/* Author and date */}
                  <p className="text-sm text-gray-500">
                    {comment.author} ‚Ä¢ {formatDate(comment.created_at)}
                  </p>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Empty state */}
        {comments.length === 0 && (
          <div className="bg-white rounded-2xl p-8 shadow-card mb-6 text-center">
            <p className="text-2xl mb-2">üí¨</p>
            <p className="text-gray-600 font-medium mb-1">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
            <p className="text-gray-500 text-sm">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç –æ—Ç–∑—ã–≤!</p>
          </div>
        )}

        {/* Description */}
        <div className="bg-white rounded-2xl p-6 shadow-card mb-6">
          <h2 className="text-xl font-bold text-gray-900 mb-3">–û–ø–∏—Å–∞–Ω–∏–µ</h2>
          <p className="text-gray-700 leading-relaxed">
            {entity.short_description}
          </p>
        </div>

        {/* Contacts */}
        <div className="bg-white rounded-2xl p-6 shadow-card mb-6">
          <h2 className="text-xl font-bold text-gray-900 mb-4">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
          
          <div className="space-y-3">
            {entity.contacts.phone && (
              <a
                href={`tel:${entity.contacts.phone.replace(/[^0-9+]/g, '')}`}
                className="flex items-center gap-3 p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-colors"
              >
                <Phone size={20} className="text-blue-600" />
                <span className="font-medium text-blue-900">
                  {entity.contacts.phone}
                </span>
              </a>
            )}

            {entity.contacts.whatsapp && (
              <a
                href={`https://wa.me/${entity.contacts.whatsapp.replace(/[^0-9]/g, '')}`}
                target="_blank"
                rel="noopener noreferrer"
                className="flex items-center gap-3 p-4 bg-green-50 rounded-xl hover:bg-green-100 transition-colors"
              >
                <MessageCircle size={20} className="text-green-600" />
                <span className="font-medium text-green-900">WhatsApp</span>
              </a>
            )}

            {entity.contacts.instagram && (
              <a
                href={`https://instagram.com/${entity.contacts.instagram.replace('@', '')}`}
                target="_blank"
                rel="noopener noreferrer"
                className="flex items-center gap-3 p-4 bg-pink-50 rounded-xl hover:bg-pink-100 transition-colors"
              >
                <Instagram size={20} className="text-pink-600" />
                <span className="font-medium text-pink-900">
                  {entity.contacts.instagram}
                </span>
              </a>
            )}

            {entity.contacts.website && (
              <a
                href={entity.contacts.website}
                target="_blank"
                rel="noopener noreferrer"
                className="flex items-center gap-3 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors"
              >
                <ExternalLink size={20} className="text-gray-600" />
                <span className="font-medium text-gray-900">–°–∞–π—Ç</span>
              </a>
            )}
          </div>
        </div>

        {/* Working Hours */}
        {entity.work_hours && (
          <div className="bg-white rounded-2xl p-6 shadow-card mb-6">
            <h2 className="text-xl font-bold text-gray-900 mb-4">–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã</h2>
            
            <div className="space-y-2">
              {entity.work_hours.monday && (
                <div className="flex justify-between items-center py-2 border-b border-gray-100">
                  <span className="text-gray-600">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</span>
                  <span className="font-medium text-gray-900">
                    {entity.work_hours.monday.closed ? '–í—ã—Ö–æ–¥–Ω–æ–π' : `${entity.work_hours.monday.open} - ${entity.work_hours.monday.close}`}
                  </span>
                </div>
              )}
              {entity.work_hours.tuesday && (
                <div className="flex justify-between items-center py-2 border-b border-gray-100">
                  <span className="text-gray-600">–í—Ç–æ—Ä–Ω–∏–∫</span>
                  <span className="font-medium text-gray-900">
                    {entity.work_hours.tuesday.closed ? '–í—ã—Ö–æ–¥–Ω–æ–π' : `${entity.work_hours.tuesday.open} - ${entity.work_hours.tuesday.close}`}
                  </span>
                </div>
              )}
              {entity.work_hours.wednesday && (
                <div className="flex justify-between items-center py-2 border-b border-gray-100">
                  <span className="text-gray-600">–°—Ä–µ–¥–∞</span>
                  <span className="font-medium text-gray-900">
                    {entity.work_hours.wednesday.closed ? '–í—ã—Ö–æ–¥–Ω–æ–π' : `${entity.work_hours.wednesday.open} - ${entity.work_hours.wednesday.close}`}
                  </span>
                </div>
              )}
              {entity.work_hours.thursday && (
                <div className="flex justify-between items-center py-2 border-b border-gray-100">
                  <span className="text-gray-600">–ß–µ—Ç–≤–µ—Ä–≥</span>
                  <span className="font-medium text-gray-900">
                    {entity.work_hours.thursday.closed ? '–í—ã—Ö–æ–¥–Ω–æ–π' : `${entity.work_hours.thursday.open} - ${entity.work_hours.thursday.close}`}
                  </span>
                </div>
              )}
              {entity.work_hours.friday && (
                <div className="flex justify-between items-center py-2 border-b border-gray-100">
                  <span className="text-gray-600">–ü—è—Ç–Ω–∏—Ü–∞</span>
                  <span className="font-medium text-gray-900">
                    {entity.work_hours.friday.closed ? '–í—ã—Ö–æ–¥–Ω–æ–π' : `${entity.work_hours.friday.open} - ${entity.work_hours.friday.close}`}
                  </span>
                </div>
              )}
              {entity.work_hours.saturday && (
                <div className="flex justify-between items-center py-2 border-b border-gray-100">
                  <span className="text-gray-600">–°—É–±–±–æ—Ç–∞</span>
                  <span className="font-medium text-gray-900">
                    {entity.work_hours.saturday.closed ? '–í—ã—Ö–æ–¥–Ω–æ–π' : `${entity.work_hours.saturday.open} - ${entity.work_hours.saturday.close}`}
                  </span>
                </div>
              )}
              {entity.work_hours.sunday && (
                <div className="flex justify-between items-center py-2">
                  <span className="text-gray-600">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</span>
                  <span className="font-medium text-gray-900">
                    {entity.work_hours.sunday.closed ? '–í—ã—Ö–æ–¥–Ω–æ–π' : `${entity.work_hours.sunday.open} - ${entity.work_hours.sunday.close}`}
                  </span>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Location */}
        {((entity.geo_lat && entity.geo_lng) || entity.address_text) && (
          <div className="bg-white rounded-2xl p-6 shadow-card">
            <h2 className="text-xl font-bold text-gray-900 mb-4">–õ–æ–∫–∞—Ü–∏—è</h2>
            
            {entity.address_text && (
              <p className="text-gray-700 mb-4">{entity.address_text}</p>
            )}

            {entity.geo_lat && entity.geo_lng && (
              <a
                href={`https://www.google.com/maps?q=${entity.geo_lat},${entity.geo_lng}`}
                target="_blank"
                rel="noopener noreferrer"
                className="flex items-center gap-3 p-4 bg-primary/10 rounded-xl hover:bg-primary/20 transition-colors"
              >
                <MapPin size={20} className="text-primary" />
                <span className="font-medium text-primary">–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</span>
              </a>
            )}
          </div>
        )}
      </div>
    </div>
  );
}
